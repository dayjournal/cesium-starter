import binarySearch from"../../Core/binarySearch.js";import ClockRange from"../../Core/ClockRange.js";import ClockStep from"../../Core/ClockStep.js";import defined from"../../Core/defined.js";import DeveloperError from"../../Core/DeveloperError.js";import JulianDate from"../../Core/JulianDate.js";import knockout from"../../ThirdParty/knockout.js";import createCommand from"../createCommand.js";import ToggleButtonViewModel from"../ToggleButtonViewModel.js";const monthNames=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],realtimeShuttleRingAngle=15,maxShuttleRingAngle=105;function numberComparator(t,e){return t-e}function getTypicalMultiplierIndex(t,e){const i=binarySearch(e,t,numberComparator);return i<0?~i:i}function angleToMultiplier(t,e){if(Math.abs(t)<=15)return t/15;let i,o;return t>0?(i=Math.log(e[e.length-1]),o=(i-0)/90,Math.exp(0+o*(t-15))):(i=Math.log(-e[0]),o=(i-0)/90,-Math.exp(0+o*(Math.abs(t)-15)))}function multiplierToAngle(t,e,i){if(i.clockStep===ClockStep.SYSTEM_CLOCK)return 15;if(Math.abs(t)<=1)return 15*t;const o=e[e.length-1];let n,r;return t>o?t=o:t<-o&&(t=-o),t>0?(n=Math.log(o),r=(n-0)/90,(Math.log(t)-0)/r+15):(n=Math.log(-e[0]),r=(n-0)/90,-((Math.log(Math.abs(t))-0)/r+15))}function AnimationViewModel(t){if(!defined(t))throw new DeveloperError("clockViewModel is required.");const e=this;this._clockViewModel=t,this._allShuttleRingTicks=[],this._dateFormatter=AnimationViewModel.defaultDateFormatter,this._timeFormatter=AnimationViewModel.defaultTimeFormatter,this.shuttleRingDragging=!1,this.snapToTicks=!1,knockout.track(this,["_allShuttleRingTicks","_dateFormatter","_timeFormatter","shuttleRingDragging","snapToTicks"]),this._sortedFilteredPositiveTicks=[],this.setShuttleRingTicks(AnimationViewModel.defaultTicks),this.timeLabel=void 0,knockout.defineProperty(this,"timeLabel",(function(){return e._timeFormatter(e._clockViewModel.currentTime,e)})),this.dateLabel=void 0,knockout.defineProperty(this,"dateLabel",(function(){return e._dateFormatter(e._clockViewModel.currentTime,e)})),this.multiplierLabel=void 0,knockout.defineProperty(this,"multiplierLabel",(function(){const t=e._clockViewModel;if(t.clockStep===ClockStep.SYSTEM_CLOCK)return"Today";const i=t.multiplier;return i%1==0?`${i.toFixed(0)}x`:`${i.toFixed(3).replace(/0{0,3}$/,"")}x`})),this.shuttleRingAngle=void 0,knockout.defineProperty(this,"shuttleRingAngle",{get:function(){return multiplierToAngle(t.multiplier,e._allShuttleRingTicks,t)},set:function(t){t=Math.max(Math.min(t,105),-105);const i=e._allShuttleRingTicks,o=e._clockViewModel;if(o.clockStep=ClockStep.SYSTEM_CLOCK_MULTIPLIER,105===Math.abs(t))return void(o.multiplier=t>0?i[i.length-1]:i[0]);let n=angleToMultiplier(t,i);if(e.snapToTicks)n=i[getTypicalMultiplierIndex(n,i)];else if(0!==n){const t=Math.abs(n);if(t>100){const e=t.toFixed(0).length-2,i=Math.pow(10,e);n=Math.round(n/i)*i|0}else t>15?n=Math.round(n):t>1?n=+n.toFixed(1):t>0&&(n=+n.toFixed(2))}o.multiplier=n}}),this._canAnimate=void 0,knockout.defineProperty(this,"_canAnimate",(function(){const t=e._clockViewModel,i=t.clockRange;if(e.shuttleRingDragging||i===ClockRange.UNBOUNDED)return!0;const o=t.multiplier,n=t.currentTime,r=t.startTime;let l=!1;if(i===ClockRange.LOOP_STOP)l=JulianDate.greaterThan(n,r)||n.equals(r)&&o>0;else{const e=t.stopTime;l=JulianDate.greaterThan(n,r)&&JulianDate.lessThan(n,e)||n.equals(r)&&o>0||n.equals(e)&&o<0}return l||(t.shouldAnimate=!1),l})),this._isSystemTimeAvailable=void 0,knockout.defineProperty(this,"_isSystemTimeAvailable",(function(){const t=e._clockViewModel;if(t.clockRange===ClockRange.UNBOUNDED)return!0;const i=t.systemTime;return JulianDate.greaterThanOrEquals(i,t.startTime)&&JulianDate.lessThanOrEquals(i,t.stopTime)})),this._isAnimating=void 0,knockout.defineProperty(this,"_isAnimating",(function(){return e._clockViewModel.shouldAnimate&&(e._canAnimate||e.shuttleRingDragging)}));const i=createCommand((function(){const t=e._clockViewModel;t.shouldAnimate?t.shouldAnimate=!1:e._canAnimate&&(t.shouldAnimate=!0)}));this._pauseViewModel=new ToggleButtonViewModel(i,{toggled:knockout.computed((function(){return!e._isAnimating})),tooltip:"Pause"});const o=createCommand((function(){const t=e._clockViewModel,i=t.multiplier;i>0&&(t.multiplier=-i),t.shouldAnimate=!0}));this._playReverseViewModel=new ToggleButtonViewModel(o,{toggled:knockout.computed((function(){return e._isAnimating&&t.multiplier<0})),tooltip:"Play Reverse"});const n=createCommand((function(){const t=e._clockViewModel,i=t.multiplier;i<0&&(t.multiplier=-i),t.shouldAnimate=!0}));this._playForwardViewModel=new ToggleButtonViewModel(n,{toggled:knockout.computed((function(){return e._isAnimating&&t.multiplier>0&&t.clockStep!==ClockStep.SYSTEM_CLOCK})),tooltip:"Play Forward"});const r=createCommand((function(){e._clockViewModel.clockStep=ClockStep.SYSTEM_CLOCK}),knockout.getObservable(this,"_isSystemTimeAvailable"));this._playRealtimeViewModel=new ToggleButtonViewModel(r,{toggled:knockout.computed((function(){return t.clockStep===ClockStep.SYSTEM_CLOCK})),tooltip:knockout.computed((function(){return e._isSystemTimeAvailable?"Today (real-time)":"Current time not in range"}))}),this._slower=createCommand((function(){const t=e._clockViewModel,i=e._allShuttleRingTicks,o=getTypicalMultiplierIndex(t.multiplier,i)-1;o>=0&&(t.multiplier=i[o])})),this._faster=createCommand((function(){const t=e._clockViewModel,i=e._allShuttleRingTicks,o=getTypicalMultiplierIndex(t.multiplier,i)+1;o<i.length&&(t.multiplier=i[o])}))}AnimationViewModel.defaultDateFormatter=function(t,e){const i=JulianDate.toGregorianDate(t);return`${monthNames[i.month-1]} ${i.day} ${i.year}`},AnimationViewModel.defaultTicks=[.001,.002,.005,.01,.02,.05,.1,.25,.5,1,2,5,10,15,30,60,120,300,600,900,1800,3600,7200,14400,21600,43200,86400,172800,345600,604800],AnimationViewModel.defaultTimeFormatter=function(t,e){const i=JulianDate.toGregorianDate(t),o=Math.round(i.millisecond);return Math.abs(e._clockViewModel.multiplier)<1?`${i.hour.toString().padStart(2,"0")}:${i.minute.toString().padStart(2,"0")}:${i.second.toString().padStart(2,"0")}.${o.toString().padStart(3,"0")}`:`${i.hour.toString().padStart(2,"0")}:${i.minute.toString().padStart(2,"0")}:${i.second.toString().padStart(2,"0")} UTC`},AnimationViewModel.prototype.getShuttleRingTicks=function(){return this._sortedFilteredPositiveTicks.slice(0)},AnimationViewModel.prototype.setShuttleRingTicks=function(t){if(!defined(t))throw new DeveloperError("positiveTicks is required.");let e,i,o;const n={},r=this._sortedFilteredPositiveTicks;for(r.length=0,e=0,i=t.length;e<i;++e)o=t[e],n.hasOwnProperty(o)||(n[o]=!0,r.push(o));r.sort(numberComparator);const l=[];for(i=r.length,e=i-1;e>=0;--e)o=r[e],0!==o&&l.push(-o);Array.prototype.push.apply(l,r),this._allShuttleRingTicks=l},Object.defineProperties(AnimationViewModel.prototype,{slower:{get:function(){return this._slower}},faster:{get:function(){return this._faster}},clockViewModel:{get:function(){return this._clockViewModel}},pauseViewModel:{get:function(){return this._pauseViewModel}},playReverseViewModel:{get:function(){return this._playReverseViewModel}},playForwardViewModel:{get:function(){return this._playForwardViewModel}},playRealtimeViewModel:{get:function(){return this._playRealtimeViewModel}},dateFormatter:{get:function(){return this._dateFormatter},set:function(t){if("function"!=typeof t)throw new DeveloperError("dateFormatter must be a function");this._dateFormatter=t}},timeFormatter:{get:function(){return this._timeFormatter},set:function(t){if("function"!=typeof t)throw new DeveloperError("timeFormatter must be a function");this._timeFormatter=t}}}),AnimationViewModel._maxShuttleRingAngle=105,AnimationViewModel._realtimeShuttleRingAngle=15;export default AnimationViewModel;